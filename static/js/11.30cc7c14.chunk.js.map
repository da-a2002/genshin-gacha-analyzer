{"version":3,"sources":["components/CanvasDataGrid.tsx","components/WorkSheet.tsx","pages/ShowPage/Timeline/getDateInfo.ts","pages/ShowPage/Timeline/CollapseWorkSheet.tsx","pages/ShowPage/Timeline/index.tsx"],"names":["scaleToWidth","grid","self","style","width","sbw","scrollBarWidth","scrollBarBorderWidth","scrollBox","dataWidth","widthBoxRatio","verticalBarVisible","showWidth","bar","v","x","scale","left","CanvasDataGrid","data","schema","attributes","onCreate","props","divEl","useRef","gridRef","useEffect","current","timer","setTimeout","canvasDataGrid","parentNode","scrollBarBoxWidth","clearTimeout","dispose","ref","editable","allowColumnResize","allowRowResize","orderBy","touchZoomMin","touchZoomMax","WorkSheet","handleCreate","useCallback","node","oldStringSorter","sorters","string","columnName","direction","sortTime","sortCount","number","l","r","info","addEventListener","e","star","row","ctx","fillStyle","COLOR","FOUR_STAR","FIVE_STAR","height","ISMOBILE","canvas","margin","cellHorizontalAlignment","activeCellHorizontalAlignment","columnHeaderCellHorizontalAlignment","font","FONT_FAMILY","cellFont","activeCellFont","columnHeaderCellFont","rowHeaderCellFont","cellColor","activeCellColor","css","format","date","mouth","getMonth","day","getDate","getFullYear","Panel","Collapse","CollapseWorkSheet","onGetData","useState","isCollapsed","setCollapsed","handleCreateGrid","orderDirection","getData","endIndex","allData","SHOW_DATA_ALL_KEY","dayStart","Date","dayEnd","startIndex","findIndex","i","length","slice","handleChange","key","activeKey","onChange","header","SCHEMA_ALL","echarts","TitleComponent","ToolboxComponent","TooltipComponent","GridComponent","DataZoomComponent","CanvasRenderer","BarChart","Timeline","echartsWrapper","myChartRef","hideZeroDay","setHideZeroDay","currentday","setCurrentDay","useCacheMemo","memoize","isHideZeroDay","countByDay","getDay","Array","isArray","value","dateList","begin","end","arr","str_b","split","str_e","date_b","setUTCFullYear","date_e","unixDb","getTime","unixDe","j","push","parseInt","getDateInfo","map","addToList","existFiveStar","count","itemStyle","color","len","时间","星级","calculateData","myChart","textStyle","fontFamily","fontWeight","options","tooltip","trigger","position","pt","title","text","toolbox","feature","dataZoom","yAxisIndex","restore","saveAsImage","xAxis","type","boundaryGap","yAxis","start","series","name","setOption","on","params","handleChangeSwitch","checked","message","banner","showIcon"],"mappings":"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","file":"static/js/11.30cc7c14.chunk.js","sourcesContent":["/** @jsxImportSource @emotion/react */\nimport React, { FC, useEffect, useRef } from 'react';\n// @ts-ignore\nimport canvasDataGrid from 'canvas-datagrid';\n\ntype CanvasDataGridProps = {\n  onCreate?: (grid: any) => void; // 获取最初的参数\n  attributes?: {\n    [key: string]: any;\n  };\n  data: Array<any> | undefined;\n  schema?: Array<any>;\n};\n// 给予canvas-datagrid一个缩放，令x轴方向不出现滚动条\nfunction scaleToWidth(grid: any) {\n  if (!grid.self) return;\n  if (grid.style.width === 'auto') return;\n  const sbw = grid.style.scrollBarWidth * 2 * grid.style.scrollBarBorderWidth * 2;\n  const { scrollBox } = grid.self;\n  let dataWidth = scrollBox.width / scrollBox.widthBoxRatio;\n  if (scrollBox.verticalBarVisible) dataWidth -= sbw;\n  const showWidth = scrollBox.bar.v.x;\n  grid.self.scale *= showWidth / (dataWidth + scrollBox.left);\n}\nexport const CanvasDataGrid: FC<\n  CanvasDataGridProps & React.HTMLAttributes<HTMLDivElement>\n> = function ({ data, schema, attributes, onCreate, ...props }) {\n  const divEl = useRef(null);\n  const gridRef = useRef(null);\n  useEffect(() => {\n    if (gridRef.current) {\n      const grid: any = gridRef.current;\n      grid.schema = schema;\n      scaleToWidth(grid);\n    }\n  }, [schema]);\n  useEffect(() => {\n    if (gridRef.current) {\n      (gridRef.current as any).data = data;\n    }\n  }, [data]);\n  useEffect(() => {\n    let grid: any;\n    const timer = setTimeout(() => {\n      grid = canvasDataGrid({\n        parentNode: divEl.current,\n        schema: schema,\n        ...attributes,\n      });\n      grid.style.scrollBarBoxWidth = 10;\n      grid.style.scrollBarWidth = 13;\n      onCreate && onCreate(grid);\n      scaleToWidth(grid);\n      gridRef.current = grid;\n      setTimeout(() => {\n        if (gridRef.current) (gridRef.current as any).data = data;\n      });\n    });\n    return () => {\n      clearTimeout(timer);\n      if (gridRef.current) {\n        (gridRef.current as any).dispose();\n        delete (gridRef.current as any).self;\n      }\n    };\n  }, []);\n  return <div ref={divEl} {...props}></div>;\n};\n","/** @jsxImportSource @emotion/react */\nimport { css } from '@emotion/react';\nimport { COLOR, FONT_FAMILY, ISMOBILE } from 'const';\nimport React, { FC, useCallback } from 'react';\nimport { CanvasDataGrid } from './CanvasDataGrid';\n\ntype WorkSheetProps = {\n  data: Array<any>;\n  schema: SchemaType;\n  onCreate?: (grid: any) => void;\n};\n\ntype SchemaType = Array<{\n  name?: string;\n  type?: string;\n  title?: string;\n  width?: number;\n  hidden?: boolean;\n  filter?: (e: any) => boolean;\n  formatter?: (e: any) => any;\n  defaultValue?: any;\n}>;\n\nconst attributes = {\n  editable: false,\n  allowColumnResize: false,\n  allowRowResize: false,\n  orderBy: '时间',\n  touchZoomMin: 0.5,\n  touchZoomMax: 1.5,\n};\nexport const WorkSheet: FC<WorkSheetProps> = function ({ data, schema, onCreate }) {\n  const handleCreate = useCallback((node: any) => {\n    if (process.env.NODE_ENV === 'development') (window as any).node = node;\n    const oldStringSorter = node.sorters.string;\n    // sortBy 时间\n    node.sorters.string = function (columnName: string, direction: string) {\n      if (columnName === '时间') {\n        const sortTime = oldStringSorter(columnName, direction);\n        const sortCount = node.sorters.number('总次数', direction);\n        return (l: any, r: any) => {\n          const info = sortTime(l, r);\n          return info === 0 ? sortCount(l, r) : info;\n        };\n      } else return oldStringSorter(columnName, direction);\n    };\n    // render color:\n    node.addEventListener('rendertext', function (e: any) {\n      const star = e.row['星级'];\n      if (star === 4) {\n        e.ctx.fillStyle = COLOR.FOUR_STAR;\n      } else if (star === 5) {\n        e.ctx.fillStyle = COLOR.FIVE_STAR;\n      }\n    });\n    node.style.height = '100%';\n    if (ISMOBILE) node.style.width = '100%';\n    node.canvas.style.margin = '0 auto';\n    node.style.cellHorizontalAlignment = 'center';\n    node.style.activeCellHorizontalAlignment = 'center';\n    node.style.columnHeaderCellHorizontalAlignment = 'center';\n    const font = '16px ' + FONT_FAMILY;\n    node.style.cellFont = font;\n    node.style.activeCellFont = font;\n    node.style.columnHeaderCellFont = font;\n    node.style.rowHeaderCellFont = font;\n    node.style.cellColor = '#262626';\n    node.style.activeCellColor = '#262626';\n    onCreate && onCreate(node);\n  }, []);\n  return (\n    <CanvasDataGrid\n      css={css`\n        width: 100%;\n        height: 100%;\n        position: relative;\n        overflow-y: hidden;\n        overflow-x: auto;\n        border-bottom: 2px dotted thistle;\n      `}\n      onCreate={handleCreate}\n      data={data}\n      schema={schema}\n      attributes={attributes}\n    />\n  );\n};\n","function format(date: Date) {\n  var mouth = date.getMonth() + 1 >= 10 ? date.getMonth() + 1 : '0' + (date.getMonth() + 1);\n  var day = date.getDate() >= 10 ? date.getDate() : '0' + date.getDate();\n  return date.getFullYear() + '-' + mouth + '-' + day; // 返回 “年-月-日”格式\n}\n\nexport function getDateInfo(begin: string, end: string) {\n  var arr = [];\n  var str_b = begin.split('-');\n  var str_e = end.split('-');\n  var date_b = new Date();\n  // @ts-ignore\n  date_b.setUTCFullYear(str_b[0], str_b[1] - 1, str_b[2]);\n  var date_e = new Date();\n  // @ts-ignore\n  date_e.setUTCFullYear(str_e[0], str_e[1] - 1, str_e[2]);\n  var unixDb = date_b.getTime();\n  var unixDe = date_e.getTime();\n  for (var j = unixDb; j <= unixDe; ) {\n    arr.push(format(new Date(parseInt(j as any))));\n    j = j + 24 * 60 * 60 * 1000;\n  }\n  return arr;\n}\n","/** @jsxImportSource @emotion/react */\nimport { css } from '@emotion/react';\nimport React, { FC, useCallback, useEffect, useMemo, useRef, useState } from 'react';\n// @ts-ignore\nimport { Collapse } from 'antd';\nimport { WorkSheet } from 'components/WorkSheet';\nimport { SCHEMA_ALL, SHOW_DATA_ALL_KEY } from 'const';\nimport { Data } from 'types';\n\nconst { Panel } = Collapse;\n\ntype CollapseWorkSheetProps = {\n  day: string;\n  onGetData: (key: string) => any;\n};\nexport const CollapseWorkSheet: FC<CollapseWorkSheetProps> = function ({ day, onGetData }) {\n  const [isCollapsed, setCollapsed] = useState(true);\n  const handleCreateGrid = useCallback((grid) => {\n    grid.orderBy = '星级';\n    grid.orderDirection = 'desc'; /// descending order;\n  }, []);\n  const getData = useCallback((day) => {\n    const allData: Data = onGetData(SHOW_DATA_ALL_KEY);\n    const dayStart = +new Date(`${day} 00:00:00`);\n    const dayEnd = dayStart + 3600 * 24 * 1000;\n    const startIndex = allData.findIndex((data) => data.date >= dayStart);\n    let endIndex;\n    for (let i = startIndex; i < allData.length; i++) {\n      if (allData[i].date >= dayEnd) {\n        endIndex = i;\n        break;\n      }\n    }\n    return allData.slice(startIndex, endIndex);\n  }, []);\n  const handleChange = useCallback((key: any) => {\n    if (key.length === 1) setCollapsed(false);\n    else setCollapsed(true);\n  }, []);\n  return (\n    <Collapse\n      activeKey={isCollapsed ? '' : '1'}\n      onChange={handleChange}\n      css={css`\n        margin-top: 12px;\n        .ant-collapse-content-box {\n          background: #f0f2f5;\n        }\n      `}\n    >\n      <Panel header={'点击展开 ' + day + ' 数据'} key='1'>\n        <div\n          css={css`\n            width: 100%;\n            height: 500px;\n          `}\n        >\n          {!isCollapsed && (\n            <WorkSheet data={getData(day)} schema={SCHEMA_ALL} onCreate={handleCreateGrid} />\n          )}\n        </div>\n      </Panel>\n    </Collapse>\n  );\n};\n","/** @jsxImportSource @emotion/react */\nimport { css } from '@emotion/react';\nimport React, { FC, useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport * as echarts from 'echarts/core';\nimport {\n  TitleComponent,\n  ToolboxComponent,\n  TooltipComponent,\n  GridComponent,\n  DataZoomComponent,\n} from 'echarts/components';\nimport { BarChart } from 'echarts/charts';\nimport { CanvasRenderer } from 'echarts/renderers';\nimport { ECharts } from 'echarts/core';\nimport { Data } from 'types';\nimport { COLOR, FONT_FAMILY, SHOW_DATA_ALL_KEY } from 'const';\nimport { Alert, Switch } from 'antd';\nimport memoize from 'lodash/memoize';\nimport { getDateInfo } from './getDateInfo';\nimport { CollapseWorkSheet } from './CollapseWorkSheet';\nimport { useCacheMemo } from 'context/CacheContext';\n\necharts.use([\n  TitleComponent,\n  ToolboxComponent,\n  TooltipComponent,\n  GridComponent,\n  DataZoomComponent,\n  CanvasRenderer,\n  BarChart,\n]);\ntype TimelineProps = {\n  onGetData: (key: string) => Data;\n};\nfunction calculateData(data: Data) {\n  const countByDay: Array<any> = [];\n  function addToList(current: { count: number; day: string; existFiveStar: boolean }) {\n    if (current.existFiveStar) {\n      countByDay.push({\n        value: [current.day, current.count],\n        itemStyle: {\n          color: COLOR.FIVE_STAR,\n        },\n      });\n    } else countByDay.push([current.day, current.count]);\n  }\n  const format = (index: number) => data[index].时间.slice(0, 10);\n  const initCurrent = () => ({\n    count: 0,\n    day: '',\n    existFiveStar: false,\n  });\n  let current = initCurrent();\n  for (let i = 0, len = data.length; i < len; i++) {\n    const day = format(i);\n    if (current.day === day) {\n      current.count += 1;\n    } else {\n      current.count && addToList(current);\n      current = initCurrent();\n      current.count += 1;\n      current.day = day;\n    }\n    if (!current.existFiveStar && data[i].星级 === 5) current.existFiveStar = true;\n  }\n  current.count && addToList(current);\n  return countByDay;\n}\nexport const Timeline: FC<TimelineProps> = function ({ onGetData }) {\n  const echartsWrapper = useRef<HTMLDivElement>(null);\n  const myChartRef = useRef<ECharts>();\n  const [hideZeroDay, setHideZeroDay] = useState(true);\n  const [currentday, setCurrentDay] = useState<string>();\n\n  // 获取数据，并写入缓存。\n  const getData = useCacheMemo(\n    () => {\n      let getData: any;\n      getData = memoize((isHideZeroDay: boolean) => {\n        if (!isHideZeroDay) {\n          const countByDay = getData(true);\n          // 如果中间日期需要显示\n          const getDay = (data: any) => (Array.isArray(data) ? data[0] : data.value[0]);\n          // 获取最开始一天和最后一天中间的日期\n          const dateList = getDateInfo(\n            getDay(countByDay[0]),\n            getDay(countByDay[countByDay.length - 1]),\n          ).map((day: string) => [day, 0]);\n          let j = 0;\n          for (let i = 0; i < countByDay.length; i++) {\n            const day = getDay(countByDay[i]);\n            while (day !== dateList[j][0]) {\n              j++;\n              if (j >= dateList.length) break;\n            }\n            dateList[j] = countByDay[i];\n          }\n          return dateList;\n        }\n        return calculateData(onGetData(SHOW_DATA_ALL_KEY));\n      });\n      return getData;\n    },\n    [],\n    'timeline',\n  );\n  useEffect(() => {\n    let myChart: ECharts;\n    if (echartsWrapper.current) {\n      myChart = echarts.init(echartsWrapper.current);\n      const textStyle = {\n        fontFamily: FONT_FAMILY,\n        fontWeight: 'normal',\n      };\n      const options = {\n        textStyle,\n        tooltip: {\n          trigger: 'axis',\n          position: function (pt: any) {\n            return [pt[0], '10%'];\n          },\n        },\n        title: {\n          left: 'center',\n          text: '抽卡数据总览',\n          textStyle,\n        },\n        toolbox: {\n          feature: {\n            dataZoom: {\n              yAxisIndex: 'none',\n            },\n            restore: {},\n            saveAsImage: {},\n          },\n        },\n        xAxis: {\n          type: 'category',\n          boundaryGap: false,\n        },\n        yAxis: {\n          type: 'value',\n          boundaryGap: false,\n        },\n        dataZoom: [\n          {\n            type: 'inside',\n            start: 0,\n            end: 100,\n          },\n          {\n            start: 0,\n            end: 100,\n          },\n        ],\n        series: [\n          {\n            name: '当日抽卡次数',\n            type: 'bar',\n            data: getData(true),\n          },\n        ],\n      };\n      options && myChart.setOption(options as any);\n      myChart.on('click', function (params: any) {\n        setCurrentDay(params.name);\n      });\n      myChartRef.current = myChart;\n    }\n\n    return () => {\n      myChart && myChart.dispose();\n    };\n  }, []);\n  useEffect(() => {\n    if (myChartRef.current) {\n      myChartRef.current.setOption({\n        title: {\n          text: `抽卡数据总览(共${onGetData(SHOW_DATA_ALL_KEY).length}抽)`,\n        },\n        xAxis: {\n          type: 'category',\n          boundaryGap: false,\n        },\n        series: [\n          {\n            name: '当日抽卡次数',\n            type: 'bar',\n            data: getData(hideZeroDay),\n          },\n        ],\n      });\n    }\n  }, [hideZeroDay]);\n  const handleChangeSwitch = useCallback((checked: boolean) => {\n    setHideZeroDay(!checked);\n  }, []);\n  return (\n    <div\n      css={css`\n        width: 100%;\n        height: 100%;\n        overflow-y: auto;\n        overflow-x: hidden;\n        position: absolute;\n      `}\n    >\n      <div\n        css={css`\n          width: 100%;\n          display: flex;\n          justify-content: center;\n          background: #e6f7ff;\n          margin: 0 0 20px;\n          .ant-alert {\n            background: #e6f7ff;\n          }\n        `}\n      >\n        <Alert\n          message={<div>点击图中数据可以查看当天的抽卡记录</div>}\n          type='info'\n          banner\n          showIcon\n        />\n      </div>\n      <div>\n        显示没有抽卡的日期: <Switch checked={!hideZeroDay} onChange={handleChangeSwitch} />\n      </div>\n      <div\n        ref={echartsWrapper}\n        css={css`\n          width: 100%;\n          height: 500px;\n        `}\n      ></div>\n      {currentday && <CollapseWorkSheet onGetData={onGetData} day={currentday} />}\n    </div>\n  );\n};\n"],"sourceRoot":""}